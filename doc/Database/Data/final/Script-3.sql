-- Tạo CSDL --
CREATE DATABASE QL_ChuanDauRa
Use QL_ChuanDauRa
DROP DATABASE QL_ChuanDauRa

CREATE TABLE KHOA
(
	MAKHOA CHAR(7) PRIMARY KEY,
	TENKHOA NVARCHAR(30) NOT NULL,
	MATK CHAR(8) NOT NULL,
	MOTA NVARCHAR(40)
)

CREATE TABLE GIAOVIEN
(
	MAGV CHAR(8) PRIMARY KEY,
	TENGV NVARCHAR(50) NOT NULL,
	MAKHOA CHAR(7),
	HOCHAM NVARCHAR(20),
	HOCVI NVARCHAR(20) NOT NULL,
	EMAIL VARCHAR(40) NOT NULL,
	SDT VARCHAR(10) NOT NULL,
	USERNAME CHAR(8) NOT NULL,
	PASSWORD VARCHAR(20) NOT NULL
)

CREATE TABLE LOPSINHHOAT
(
	MALOP CHAR(15) PRIMARY KEY,
	TENLOP NVARCHAR(40) NOT NULL,
	MAKHOA CHAR(7),
	MAGV CHAR(8)
)

CREATE TABLE SINHVIEN
(
	MSSV CHAR(8) PRIMARY KEY,
	TENSV NVARCHAR(50) NOT NULL,
	MALOP CHAR(15),
	EMAIL VARCHAR(40) NOT NULL,
	SDT VARCHAR(10),
	USERNAME CHAR(8) NOT NULL,
	PASSWORD VARCHAR(20) NOT NULL,
	MOTA NVARCHAR(40)
)

CREATE TABLE LOPHOC
(
	MALOPHOC CHAR(11),
	MAMH CHAR(5),
	MAGV CHAR(8),
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	SISO INT NOT NULL,
	TINHTRANG NVARCHAR(30),
	PRIMARY KEY(MALOPHOC,HOCKY,NAMHOC)
)

CREATE TABLE MONHOC
(
	MAMH CHAR(5) PRIMARY KEY,
	TENMH NVARCHAR(40) NOT NULL,
	MAKHOA CHAR(7)
)

CREATE TABLE BANGDIEM
(
	MSSV CHAR(8),
	MALOPHOC CHAR(11),
	DIEMQT FLOAT,
	DIEMGK FLOAT NOT NULL,
	DIEMTH FLOAT,
	DIEMCK FLOAT NOT NULL,
	DIEMTB FLOAT NOT NULL,
	KETQUA NVARCHAR(20) NOT NULL,
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	PRIMARY KEY(MSSV,MALOPHOC,HOCKY,NAMHOC)
)

CREATE TABLE SV_CHUANDAURA
(
	MSSV CHAR(8),
	MACHUANDR CHAR(6),
	QUATRINH INT NOT NULL,
	PRIMARY KEY(MSSV,MACHUANDR)
)

CREATE TABLE SV_CHUANMH
(
	MSSV CHAR(8),
	MALOPHOC CHAR(11),
	MACHUANMH CHAR(2),
	QUATRINH INT NOT NULL,
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	PRIMARY KEY(MSSV,MALOPHOC,MACHUANMH, NAMHOC, HOCKY)
)

CREATE TABLE CHUANDAURA
(
	MACHUANDR CHAR(6) NOT NULL,
	MAKHOA CHAR(7),
	TENCHUANDR NVARCHAR(100) NOT NULL,
	TOITHIEU INT NOT NULL,
	PRIMARY KEY(MACHUANDR,MAKHOA)
)

CREATE TABLE CHUANMH
(
	MACHUANMH CHAR(2) NOT NULL,
	MAMH CHAR(5),
	TRONGSOQT FLOAT,
	TRONGSOGK FLOAT NOT NULL,
	TRONGSOTH FLOAT,
	TRONGSOCK FLOAT NOT NULL,
	PRIMARY KEY(MACHUANMH,MAMH)
)

CREATE TABLE CHUANDAURA_CHUANQUATRINH
(
	MACHUANDR_MH CHAR(3),
	MACHUANMH CHAR(2),
	MAKHOA CHAR(7),
	MAMH CHAR(5),
	TRONGSO FLOAT NOT NULL,
	PRIMARY KEY(MACHUANDR_MH,MACHUANMH,MAMH,MAKHOA)
)

-- Tạo ràng buộc khoá chính, khoá ngoại trên các Table --
ALTER TABLE KHOA ADD
	CONSTRAINT FK_KH_GV FOREIGN KEY (MATK) REFERENCES GIAOVIEN(MAGV)
	
ALTER TABLE GIAOVIEN ADD
	CONSTRAINT FK_GV_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE LOPSINHHOAT ADD
	CONSTRAINT FK_LSH_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT FK_LSH_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE SINHVIEN ADD
	CONSTRAINT FK_SV_LSH FOREIGN KEY (MALOP) REFERENCES LOPSINHHOAT(MALOP)

ALTER TABLE LOPHOC ADD
	CONSTRAINT FK_LH_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV),
	CONSTRAINT FK_LH_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE MONHOC ADD
	CONSTRAINT FK_MH_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
	
ALTER TABLE BANGDIEM ADD
	CONSTRAINT FK_BD_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE SV_CHUANDAURA ADD
	CONSTRAINT FK_SVCDR_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE SV_CHUANMH ADD
	CONSTRAINT FK_SVCMH_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE CHUANDAURA ADD
	CONSTRAINT FK_CDR_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE CHUANMH ADD
	CONSTRAINT FK_CMH_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE CHUANDAURA_CHUANQUATRINH ADD
	CONSTRAINT FK_CDR_CQT_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT FK_CDR_CQT_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

Set dateformat dmy



SELECT MAGV, TENGV, EMAIL, SDT, TENKHOA FROM GIAOVIEN,  KHOA 
 WHERE GIAOVIEN.MAKHOA=KHOA.MAKHOA AND  MAGV = 'DH987632'
 
 SELECT MIN(NAMHOC) AS NAMBD, COUNT(MALOPHOC) AS SOLOP  FROM LOPHOC WHERE MAGV = 'DH987632'
 
 SELECT AVG(QUATRINH) TB, COUNT(DISTINCT MSSV) SV, LOPHOC.MALOPHOC FROM LOPHOC, SV_CHUANMH 
 WHERE LOPHOC.MALOPHOC=SV_CHUANMH.MALOPHOC AND LOPHOC.NAMHOC=SV_CHUANMH.NAMHOC 
 AND LOPHOC.HOCKY=SV_CHUANMH.HOCKY AND MAGV = 'DH987632'
 GROUP BY LOPHOC.MALOPHOC
 
 SELECT COUNT(MALOPHOC) SOLOP, LOPHOC.MAMH, TENMH  FROM LOPHOC, MONHOC 
WHERE LOPHOC.MAMH = MONHOC.MAMH AND MAGV = 'DH987632'
GROUP BY LOPHOC.MAMH, TENMH

SELECT COUNT(MALOPHOC) SOLOP, NAMHOC FROM LOPHOC WHERE MAGV='DH987632'
GROUP BY NAMHOC

SELECT COUNT(MALOPHOC)
FROM (SELECT AVG(QUATRINH) QUATRINH, LOPHOC.NAMHOC, LOPHOC.HOCKY, LOPHOC.MALOPHOC, LOPHOC.MAGV FROM LOPHOC, SV_CHUANMH 
WHERE LOPHOC.MALOPHOC = SV_CHUANMH.MALOPHOC 
GROUP BY LOPHOC.NAMHOC, LOPHOC.MALOPHOC, LOPHOC.HOCKY, LOPHOC.MAGV) GIANGDAY
WHERE MAGV = 'DH987632' AND QUATRINH >= 70

SELECT TOP 1 QUATRINH, MALOPHOC, HOCKY, NAMHOC
FROM (SELECT AVG(QUATRINH) QUATRINH, LOPHOC.NAMHOC, LOPHOC.HOCKY, LOPHOC.MALOPHOC, LOPHOC.MAGV FROM LOPHOC, SV_CHUANMH 
WHERE LOPHOC.MALOPHOC = SV_CHUANMH.MALOPHOC 
GROUP BY LOPHOC.NAMHOC, LOPHOC.MALOPHOC, LOPHOC.HOCKY, LOPHOC.MAGV) GIANGDAY
WHERE MAGV = 'DH987632'
ORDER BY QUATRINH DESC

SELECT LOPHOC.MAGV, TENGV, COUNT(MALOPHOC), HOCHAM, HOCVI
FROM LOPHOC, 
(SELECT GIAOVIEN.MAGV, TENGV, HOCHAM, HOCVI
FROM KHOA, GIAOVIEN
WHERE KHOA.MAKHOA = GIAOVIEN.MAKHOA AND MATK = 'DH134498') GIAOVIEN
WHERE LOPHOC.MAGV = GIAOVIEN.MAGV
GROUP BY TENGV, LOPHOC.MAGV, HOCHAM, HOCVI

SELECT COUNT(QUATRINH), SINHVIEN.MSSV, TENSV, MALOP
FROM SV_CHUANDAURA,
(SELECT SINHVIEN.MSSV, TENSV, MALOP
FROM (SELECT MAKHOA, MSSV, TENSV, SINHVIEN.MALOP FROM SINHVIEN, LOPSINHHOAT WHERE SINHVIEN.MALOP = LOPSINHHOAT.MALOP) SINHVIEN, KHOA
WHERE SINHVIEN.MAKHOA = KHOA.MAKHOA AND MATK = 'DH134498') SINHVIEN
WHERE SINHVIEN.MSSV = SV_CHUANDAURA.MSSV AND QUATRINH >= 60
GROUP BY SINHVIEN.MSSV, TENSV, MALOP


SELECT GIAOVIEN.MAGV, MAKHOA, HOCHAM, HOCVI, TENGV
FROM (SELECT AVG(QUATRINH) QUATRINH, LOPHOC.NAMHOC, LOPHOC.HOCKY, LOPHOC.MALOPHOC, LOPHOC.MAGV FROM LOPHOC, SV_CHUANMH 
WHERE LOPHOC.MALOPHOC = SV_CHUANMH.MALOPHOC 
GROUP BY LOPHOC.NAMHOC, LOPHOC.MALOPHOC, LOPHOC.HOCKY, LOPHOC.MAGV) GIANGDAY, GIAOVIEN
WHERE GIANGDAY.MAGV = GIAOVIEN.MAGV

SELECT MSSV, TENSV, EMAIL, SDT, SINHVIEN.MALOP, TENKHOA FROM SINHVIEN, 
(SELECT MALOP,TENKHOA FROM KHOA, LOPSINHHOAT WHERE KHOA.MAKHOA = LOPSINHHOAT.MAKHOA) LOP_KHOA
WHERE SINHVIEN.MALOP = LOP_KHOA.MALOP
AND MSSV='16529863'

SELECT MIN(NAMHOC), AVG(DIEMTB), COUNT(MALOPHOC)
FROM BANGDIEM
WHERE MSSV = '16529863'

SELECT QUATRINH, TOITHIEU, LO.MSSV, LO.MACHUANDR, TENCHUANDR
FROM SV_CHUANDAURA,
(SELECT DISTINCT MACHUANDR, TENCHUANDR, KHOA.MAKHOA, TOITHIEU, MSSV
FROM CHUANDAURA, 
(SELECT DISTINCT MAKHOA, MSSV
FROM SINHVIEN, LOPSINHHOAT
WHERE SINHVIEN.MALOP = LOPSINHHOAT.MALOP AND MSSV = '16529863') KHOA
WHERE KHOA.MAKHOA = CHUANDAURA.MAKHOA) LO
WHERE LO.MACHUANDR = SV_CHUANDAURA.MACHUANDR AND LO.MSSV = SV_CHUANDAURA.MSSV

UPDATE BANGDIEM SET DIEMQT=4, DIEMTH=10, DIEMGK=10, DIEMCK=5, DIEMTB=6.3 WHERE MSSV='17520023' 
AND MALOPHOC='IE213.J11' AND HOCKY=2 AND NAMHOC=2017

SELECT MACHUANMH, TRONGSOQT, TRONGSOTH, TRONGSOCK, TRONGSOGK
FROM CHUANMH, LOPHOC
WHERE CHUANMH.MAMH = LOPHOC.MAMH AND LOPHOC.MALOPHOC = 'IE213.J11'


SELECT MSSV, DIEMQT, DIEMTH, DIEMGK, DIEMCK
FROM BANGDIEM
WHERE MALOPHOC = 'IE213.J11' AND HOCKY = 2 AND NAMHOC=2017

UPDATE SV_CHUANMH
SET QUATRINH = 100
WHERE MSSV = '17520023' AND MALOPHOC = 'IE213.J11' AND MACHUANMH = 'G1' AND HOCKY = 2 AND NAMHOC=2017

SELECT MACHUANMH, TRONGSOQT, TRONGSOTH, TRONGSOCK, TRONGSOGK, DIEMQT, DIEMTH, DIEMGK, DIEMCK
FROM CHUANMH,
(SELECT MAMH, LOPHOC.MALOPHOC, MSSV, DIEMQT, DIEMGK, DIEMTH, DIEMCK 
FROM BANGDIEM, LOPHOC
WHERE BANGDIEM.MALOPHOC = LOPHOC.MALOPHOC) MH
WHERE CHUANMH.MAMH = MH.MAMH

SELECT DISTINCT MONHOC.MAMH, TENMH, DIEMQT, DIEMCK, DIEMGK, DIEMTH, DIEMTB, HOCKY, NAMHOC FROM MONHOC, 
(SELECT MSSV, MAMH, DIEMQT, DIEMGK, DIEMCK, DIEMTH, DIEMTB, BANGDIEM.HOCKY, BANGDIEM.NAMHOC 
FROM BANGDIEM, LOPHOC 
WHERE BANGDIEM.MALOPHOC = LOPHOC.MALOPHOC) DIEM
WHERE MSSV = '16529863' AND DIEM.MAMH = MONHOC.MAMH
ORDER BY NAMHOC, HOCKY

SELECT SOSV
FROM KHOA, 
(SELECT MAKHOA, COUNT(MSSV) SOSV FROM LOPSINHHOAT, SINHVIEN 
WHERE SINHVIEN.MALOP = LOPSINHHOAT.MALOP GROUP BY MAKHOA) KHOASV
WHERE KHOA.MAKHOA = KHOASV.MAKHOA AND MATK = 'DH134498'

SELECT DISTINCT MALOPHOC FROM LOPHOC WHERE MAGV='DH987632' AND NAMHOC = 2017 AND HOCKY = 2

Select distinct MALOPHOC, NAMHOC, HOCKY from LOPHOC where MAGV='DH151754' AND NAMHOC=2017 AND HOCKY=1