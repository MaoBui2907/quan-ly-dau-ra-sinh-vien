-- Tạo CSDL --
CREATE DATABASE QL_ChuanDauRa
Use QL_ChuanDauRa

CREATE TABLE KHOA
(
	MAKHOA CHAR(7) PRIMARY KEY,
	TENKHOA NVARCHAR(30) NOT NULL,
	MATK CHAR(8) NOT NULL,
	MOTA NVARCHAR(40)
)

CREATE TABLE GIAOVIEN
(
	MAGV CHAR(8) PRIMARY KEY,
	TENGV NVARCHAR(50) NOT NULL,
	MAKHOA CHAR(7),
	HOCHAM NVARCHAR(20),
	HOCVI NVARCHAR(20) NOT NULL,
	EMAIL VARCHAR(40) NOT NULL,
	SDT VARCHAR(10) NOT NULL,
	USERNAME CHAR(8) NOT NULL,
	PASSWORD VARCHAR(20) NOT NULL
)

CREATE TABLE LOPSINHHOAT
(
	MALOP CHAR(15) PRIMARY KEY,
	TENLOP NVARCHAR(40) NOT NULL,
	MAKHOA CHAR(7),
	MAGV CHAR(8)
)

CREATE TABLE SINHVIEN
(
	MSSV CHAR(8) PRIMARY KEY,
	TENSV NVARCHAR(50) NOT NULL,
	MALOP CHAR(15),
	EMAIL VARCHAR(40) NOT NULL,
	SDT VARCHAR(10),
	USERNAME CHAR(8) NOT NULL,
	PASSWORD VARCHAR(20) NOT NULL,
	MOTA NVARCHAR(40)
)

CREATE TABLE LOPHOC
(
	MALOPHOC CHAR(11),
	MAMH CHAR(5),
	MAGV CHAR(8),
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	SISO INT NOT NULL,
	TINHTRANG NVARCHAR(30),
	PRIMARY KEY(MALOPHOC,HOCKY,NAMHOC)
)

CREATE TABLE MONHOC
(
	MAMH CHAR(5) PRIMARY KEY,
	TENMH NVARCHAR(40) NOT NULL,
	MAKHOA CHAR(7)
)

CREATE TABLE BANGDIEM
(
	MSSV CHAR(8),
	MALOPHOC CHAR(11),
	DIEMQT FLOAT,
	DIEMGK FLOAT NOT NULL,
	DIEMTH FLOAT,
	DIEMCK FLOAT NOT NULL,
	DIEMTB FLOAT NOT NULL,
	KETQUA NVARCHAR(20) NOT NULL,
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	PRIMARY KEY(MSSV,MALOPHOC,HOCKY,NAMHOC)
)

CREATE TABLE SV_CHUANDAURA
(
	MSSV CHAR(8),
	MACHUANDR CHAR(6),
	QUATRINH INT NOT NULL,
	PRIMARY KEY(MSSV,MACHUANDR)
)

CREATE TABLE SV_CHUANMH
(
	MSSV CHAR(8),
	MALOPHOC CHAR(11),
	MACHUANMH CHAR(2),
	QUATRINH INT NOT NULL,
	HOCKY SMALLINT NOT NULL,
	NAMHOC INT NOT NULL,
	PRIMARY KEY(MSSV,MALOPHOC,MACHUANMH)
)

CREATE TABLE CHUANDAURA
(
	MACHUANDR CHAR(6) NOT NULL,
	MAKHOA CHAR(7),
	TENCHUANDR NVARCHAR(100) NOT NULL,
	TOITHIEU INT NOT NULL,
	PRIMARY KEY(MACHUANDR,MAKHOA)
)

CREATE TABLE CHUANMH
(
	MACHUANMH CHAR(2) NOT NULL,
	MAMH CHAR(5),
	TRONGSOQT FLOAT,
	TRONGSOGK FLOAT NOT NULL,
	TRONGSOTH FLOAT,
	TRONGSOCK FLOAT NOT NULL,
	PRIMARY KEY(MACHUANMH,MAMH)
)

CREATE TABLE CHUANDAURA_CHUANQUATRINH
(
	MACHUANDR_MH CHAR(3),
	MACHUANMH CHAR(2),
	MAKHOA CHAR(7),
	MAMH CHAR(5),
	TRONGSO FLOAT NOT NULL,
	PRIMARY KEY(MACHUANDR_MH,MACHUANMH,MAMH,MAKHOA)
)

-- Tạo ràng buộc khoá chính, khoá ngoại trên các Table --
ALTER TABLE KHOA ADD
	CONSTRAINT FK_KH_GV FOREIGN KEY (MATK) REFERENCES GIAOVIEN(MAGV)
	
ALTER TABLE GIAOVIEN ADD
	CONSTRAINT FK_GV_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE LOPSINHHOAT ADD
	CONSTRAINT FK_LSH_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT FK_LSH_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE SINHVIEN ADD
	CONSTRAINT FK_SV_LSH FOREIGN KEY (MALOP) REFERENCES LOPSINHHOAT(MALOP)

ALTER TABLE LOPHOC ADD
	CONSTRAINT FK_LH_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV),
	CONSTRAINT FK_LH_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE MONHOC ADD
	CONSTRAINT FK_MH_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
	
ALTER TABLE BANGDIEM ADD
	CONSTRAINT FK_BD_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE SV_CHUANDAURA ADD
	CONSTRAINT FK_SVCDR_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE SV_CHUANMH ADD
	CONSTRAINT FK_SVCMH_SV FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE CHUANDAURA ADD
	CONSTRAINT FK_CDR_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE CHUANMH ADD
	CONSTRAINT FK_CMH_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE CHUANDAURA_CHUANQUATRINH ADD
	CONSTRAINT FK_CDR_CQT_KH FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT FK_CDR_CQT_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

Set dateformat dmy

